# 動的ボクセル解像度システム 導入タスク計画

## 1. 最終目標
- **高負荷MMO向け適応ボクセル**: プレイヤー行動と属性勾配に応じてボクセル解像度を動的制御し、流体・温度・穢れ等の属性を高精度で表現する。
- **分散サーバー運用**: 複数サーバーで一貫性を維持しながら高頻度更新を処理できるデータ構造とトランザクション制御を構築する。
- **ビジュアル統合**: レンダリング、UI、AI制御と連携し、ゲームプレイの中核メカニクスとして機能させる。

## 2. 前提条件
- **エンジン基盤**: Unreal Engine 5.x、C++を主実装言語とする。
- **ネットワーク構成**: MMOサーバーは複数インスタンスで稼働し、データ同期は非同期キュー＋トランザクション制御を想定。
- **現状の進捗**: `UAdaptiveVoxelSubsystem` による分割・結合PoCが存在するが、ボクセル実データ・可視化・属性計算・同期は未実装。
- **依存ロードマップ**: `Development_Roadmap_Phase0.md` の「ステップ2: コアゲームプレイ機能」で定義される装備・インベントリ・HUD基盤を最小要件とする。

## 3. アーキテクチャ概要
- **データ層**: リニアOctree＋プレアロケートスラブで構成される`FAdaptiveVoxelTree`（新規）を基盤とし、CPU/GPUメモリの効率化を図る。
- **制御層**: `UAdaptiveVoxelSubsystem` が各ワールドでノード管理、Refine/Derefine判定、興味領域の集約を実施。
- **シミュレーション層**: Staggered Octree Poisson離散化ベースの流体ソルバ、属性勾配検出、AI環境クエリ。
- **レンダリング層**: GPUメッシング、マテリアル更新、LOD同期。
- **同期層**: MVCC/OCCベースのトランザクション管理、差分レプリケーション、ログ収集。

## 4. ワークストリームと主要タスク
### 4.1 データ構造・ランタイム
- **[タスク]** リニアOctree基盤の設計 (`FAdaptiveVoxelTree`, `FAdaptiveVoxelNodeHandle`).
- **[タスク]** スレッドセーフなノード割当て／解放アルゴリズム。
- **[タスク]** ボクセル属性格納フォーマット定義（温度・穢れ・マナ等）。
- **[成果物]** C++実装＋単体テスト、性能ベンチマーク結果。

### 4.2 サブシステム強化
- **[タスク]** `UAdaptiveVoxelSubsystem` にノードグラフ連携APIを追加 (`RegisterWorldVolume`, `SyncToTree`).
- **[タスク]** ゲームイベント入力（爆発、魔法等）を興味領域に反映する`UAdaptiveVoxelEventRouter`。
- **[タスク]** デバッグ可視化 (`DrawDebugBox`, `UAdaptiveVoxelDebugComponent`).
- **[成果物]** Blueprint/Editor操作ガイド、ログ出力仕様。

### 4.3 シミュレーション統合
- **[タスク]** Staggered Octree Poisson離散化ソルバ`FAdaptiveFluidSolver`のPoC実装（CPU→GPU移植計画）。
- **[タスク]** 属性更新ループ（温度・マナ・穢れ）とノードデータの双方向同期。
- **[タスク]** AI環境クエリへのHook（`UAISense_VoxelAttributes`）。
- **[成果物]** ソルバ評価レポート、属性シミュレーションの自動テスト。

### 4.4 レンダリング／UI
- **[タスク]** GPUメッシングパイプラインの導入（Greedy Meshing検証、可変LOD対応）。
- **[タスク]** マテリアル・ポストプロセスの属性反映。
- **[タスク]** UI/デバッグHUDでの解像度・属性ヒートマップ表示。
- **[成果物]** レンダリング性能テスト、UIデザインガイド。

### 4.5 サーバー同期・分散制御
- **[タスク]** MVCC/OCCを応用したトランザクション管理層の設計（`FAdaptiveVoxelTransaction`）。
- **[タスク]** 差分レプリケーションプロトコル、信頼性キュー実装。
- **[タスク]** ロードバランサーとのインターフェース、フェイルオーバー手順策定。
- **[成果物]** ネットワーク検証環境、障害復旧Runbook。

### 4.6 ツール・運用
- **[タスク]** オフラインビルダー（初期Octree生成ツール）。
- **[タスク]** プロファイリング／モニタリング（Unreal Insights＋Grafana連携）。
- **[タスク]** QAシナリオ自動化（負荷テスト、再現用リプレイ）。
- **[成果物]** ドキュメント、CI/CD統合。

### 4.7 階層神AI・ゲームメカニクス
- **[タスク]** 階層構造の神々モデル設計（権能レベル、監視領域、信仰度メトリクス）。
- **[タスク]** 神々とボクセル解像度の連動ロジック実装（低解像度監視→高解像度干渉トリガー）。
- **[タスク]** プレイヤー行動・クエストとの連携仕様策定（信仰獲得/喪失、AI意思決定）。
- **[タスク]** サーバー同期とAIガバナンスルール（神間調停、負荷分散ポリシー）。
- **[成果物]** デザインドキュメント、`UGodHierarchySubsystem` PoC、プレイテストシナリオ。

### 4.8 装備・採掘インタラクション統合
- **[タスク]** 装備データモデルの精査（剣、つるはし等のカテゴリ、耐久値、属性付与）。
- **[タスク]** 攻撃／採掘イベントからボクセル編集リクエストを生成する`UAdaptiveVoxelEventRouter`設計・実装。
- **[タスク]** `UAdaptiveVoxelSubsystem` にボクセル破壊・生成API、耐久値消費、素材ドロップ連携を追加。
- **[タスク]** `UInventoryComponent` との連動（素材取得、装備消耗）、アビリティ／アニメーションとの統合テスト。
- **[成果物]** 装備連動仕様書、統合テストケース、プレイヤー向けUXモックアップ。

## 5. マイルストーン
| フェーズ | 想定期間 | 主要成果物 | エグジット基準 |
|----------|----------|-------------|----------------|
| PoC (Phase 0) | 6-8 週間 | リニアOctree＋簡易ソルバ連携、デバッグ可視化、神々モデル草案、装備イベント→ボクセルトリガーPoC | 30Hzでの局所Refine/Derefine安定動作、基本属性更新と神々・装備シミュレーショントリガーが機能 |
| Alpha (Phase 1) | 8-10 週間 | GPUメッシング、属性シミュレーション精度検証、MVCCモック、`UGodHierarchySubsystem` PoC、装備統合テストv1 | サーバー単体で100同時プレイヤー＋神々AI・装備イベントの負荷テストに合格 |
| Beta (Phase 2) | 10-12 週間 | 分散同期、AI統合、UIツール、信仰度メカニクス、採掘/戦闘フロー | マルチサーバー環境でのレプリケーション整合性、神々介入と装備干渉シナリオを含む主要ゲームシナリオでの検証完了 |
| Production (Phase 3) | 6 週間 | 運用Runbook、CI/CD、監視整備、ライブイベント運用フロー、装備コンテンツ運用手順 | SLA/SLI達成、神々・装備コンテンツを含むリリース承認 |

## 6. リスクと対応策
- **[技術リスク]** 流体ソルバの性能不足 → 早期GPU化検証、外部ライブラリ調査。
- **[運用リスク]** 分散トランザクションの競合 → コンフリクト頻度を測定し、OCCからMVCCへの切替条件を定義。
- **[開発リソース]** 専門スキル不足 → 研究開発枠の確保、外部コンサル活用検討。

## 7. 次アクション
- **[短期]** デバッグ可視化コンポーネント実装、PoCプレイヤーイベント連携。
- **[中期]** `FAdaptiveVoxelTree` のプロトタイプ作成と性能測定。
- **[長期]** Staggered Octree PoissonソルバのGPU移植、分散同期実装、神々AIメタゲームと装備干渉の統合テスト。

## 8. ロードマップ連携
- **Phase 0整合**: `Development_Roadmap_Phase0.md#ステップ2-コアゲームプレイ機能` の進捗を確認し、装備データモデルとインベントリUIが安定稼働していることをアドプト条件とする。
- **タスクID連携**: 本計画の `4.8` 項目を `Development_Roadmap_Phase0.md` の「2.5 AdaptiveVoxel準備タスク（新規）」にマッピングし、共通ID `[Task-AV-Equip-01]` でトラッキング。
- **フェーズ移行**: Phase 0完了判定時に、本計画のPhase 0マイルストーンとロードマップの「Phase 1移行条件」を同時にチェックする運用を設定する。
